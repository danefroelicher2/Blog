name: Keep Supabase Active with Real Activity

on:
  schedule:
    - cron: '1 5 * * 4'  # Thursday 12:01 AM EST (5:01 AM UTC)
    - cron: '0 0 * * 1'  # Sunday 7:00 PM EST (Monday 12:00 AM UTC)
  workflow_dispatch:

jobs:
  keep-active:
    runs-on: ubuntu-latest

    steps:
      - name: Perform Real Database Activity
        run: |
          echo "üîÑ Performing real database activity to prevent Supabase pause..."

          echo "üìñ Looking for test post with title 'test'..."
          GET_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/posts?select=id,title,content&title=eq.test&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}")

          GET_HTTP_CODE=$(echo "$GET_RESPONSE" | tail -n1)
          GET_BODY=$(echo "$GET_RESPONSE" | head -n-1)

          echo "Get Response Code: $GET_HTTP_CODE"
          echo "Get Response Body: $GET_BODY"

          if [ "$GET_HTTP_CODE" != "200" ]; then
            echo "‚ö†Ô∏è Failed to fetch test post - Status: $GET_HTTP_CODE"
            exit 1
          fi

          POST_ID=$(echo "$GET_BODY" | grep -o '"id":[0-9]*' | head -1 | grep -o '[0-9]*')
          CURRENT_CONTENT=$(echo "$GET_BODY" | sed -n 's/.*"content":"\([^"]*\)".*/\1/p')

          if [ -z "$POST_ID" ]; then
            echo "‚ùå Test post with title 'test' not found!"
            exit 1
          fi

          echo "‚úÖ Found test post with ID: $POST_ID"
          echo "üìù Current content: $CURRENT_CONTENT"

          if [ -z "$CURRENT_CONTENT" ]; then
            NEW_CONTENT="1"
          else
            NUM_COUNT=$(echo "$CURRENT_CONTENT" | tr -cd ',' | wc -c)
            NEXT_NUM=$((NUM_COUNT + 2))
            NEW_CONTENT="${CURRENT_CONTENT},${NEXT_NUM}"
          fi

          echo "üìù New content will be: $NEW_CONTENT"

          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          ESCAPED_CONTENT=$(echo "$NEW_CONTENT" | sed 's/"/\\"/g')

          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/posts?id=eq.$POST_ID" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"content\":\"$ESCAPED_CONTENT\",\"updated_at\":\"$CURRENT_TIME\"}")

          UPDATE_HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)

          if [ "$UPDATE_HTTP_CODE" = "204" ] || [ "$UPDATE_HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully updated test post!"
            echo "üìä Old content: $CURRENT_CONTENT ‚Üí New content: $NEW_CONTENT"
          else
            echo "‚ö†Ô∏è Update failed with status $UPDATE_HTTP_CODE"
            exit 1
          fi
